<!-- templates/checkout/checkout.html -->
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="fragments/user/header :: layout(~{::body})">
<body style="background:#0b1220;color:#e5e7eb;font-family:'Inter',sans-serif;">

<style>
  :root{
    --bg:#0b1220;
    --card:#111827;
    --border:rgba(148,163,184,.25);
    --muted:#94a3b8;
    --text:#e5e7eb;
    --primary:#22c55e;
    --secondary:#60a5fa;
  }

  h4{
    font-weight:800;
    color:#d1fae5;
    margin:1rem 0 1.5rem;
    text-shadow:0 0 10px rgba(34,197,94,.15);
  }

  .checkout-card{
    background:rgba(17,24,39,.55);
    border:1px solid var(--border);
    border-radius:16px;
    box-shadow:0 16px 40px rgba(0,0,0,.6);
    padding:16px 20px;
    color:var(--text);
  }

  .checkout-label{
    font-size:.8rem;
    font-weight:600;
    color:#94a3b8;
    margin-bottom:4px;
  }

  .summary-box{
    background:rgba(15,23,42,.6);
    border:1px solid var(--border);
    border-radius:14px;
    padding:16px 20px;
  }

  .mini-item-row{
    display:flex;
    justify-content:space-between;
    font-size:.85rem;
    color:#fff;
    margin-bottom:.5rem;
  }
  .mini-item-row .name{
    font-weight:500;
    max-width:70%;
  }
  .mini-item-row .qty{
    color:#94a3b8;
    font-size:.8rem;
    font-weight:500;
  }

  .line-item{
    display:flex;
    justify-content:space-between;
    color:#fff;
    font-size:.9rem;
    font-weight:500;
    margin-bottom:.35rem;
  }

  .total-line{
    font-size:1.1rem;
    font-weight:700;
    background:linear-gradient(135deg,#a7f3d0,#93c5fd);
    -webkit-background-clip:text;
    background-clip:text;
    color:transparent;
  }

  .form-control{
    background:rgba(15,23,42,.6);
    border:1px solid var(--border);
    color:#fff;
    border-radius:12px;
  }
  .form-control::placeholder{
    color:#fff;
    opacity:.7;
  }
  .form-control:focus{
    border-color:#60a5fa;
    box-shadow:0 0 0 6px rgba(96,165,250,.25);
    background:rgba(15,23,42,.85);
    color:#fff;
  }

  .note-area{
    background:rgba(15,23,42,.6);
    border:1px solid var(--border);
    border-radius:12px;
    color:#fff;
    width:100%;
    font-size:.9rem;
    line-height:1.4;
  }
  .note-area::placeholder{
    color:#fff;
    opacity:.6;
  }
  .note-area:focus{
    outline:none;
    border-color:#60a5fa;
    box-shadow:0 0 0 6px rgba(96,165,250,.25);
    background:rgba(15,23,42,.85);
  }

  .addr-option{
    background:rgba(15,23,42,.6);
    border:1px solid rgba(148,163,184,.25);
    border-radius:12px;
    padding:12px 16px;
    color:#fff;
    position:relative;
    box-shadow:0 12px 32px rgba(0,0,0,.5);
    margin-bottom:12px;
    cursor:default;
    transition:box-shadow .16s, border .16s;
  }

  .addr-active{
    border:1px solid #22c55e !important;
    box-shadow:
      0 0 20px rgba(34,197,94,.4),
      0 16px 40px rgba(0,0,0,.7);
  }

  .addr-default-pill{
    background:#22c55e;
    color:#0b1220;
    border-radius:6px;
    font-size:.7rem;
    font-weight:700;
    padding:4px 8px;
    text-transform:uppercase;
    line-height:1.2;
    white-space:nowrap;
  }

  .branch-ok{
    font-size:.8rem;
    color:#94a3b8;
    line-height:1.4;
  }
  .branch-warning{
    font-size:.8rem;
    color:#facc15;
    line-height:1.4;
  }

  .btn-primary{
    background:linear-gradient(135deg,var(--primary),var(--secondary));
    border:none;
    color:#07131f;
    font-weight:800;
    box-shadow:0 6px 18px rgba(34,197,94,.25);
    border-radius:12px;
    padding:.6rem 1rem;
    width:100%;
    transition:filter .16s, transform .16s;
  }
  .btn-primary:hover:enabled{
    filter:saturate(1.05);
    transform:translateY(-1px);
  }
  .btn-primary:disabled{
    opacity:.4;
    cursor:not-allowed;
    filter:none;
    transform:none;
  }

  .error-box{
    background:rgba(239,68,68,.12);
    border:1px solid rgba(239,68,68,.5);
    color:#fecaca;
    border-radius:12px;
    font-size:.9rem;
    font-weight:500;
    line-height:1.4;
    padding:.75rem 1rem;
    margin-bottom:1rem;
  }

  .link-manage-address{
    font-size:.8rem;
    color:#93c5fd;
    text-decoration:none;
    font-weight:600;
  }
  .link-manage-address:hover{
    color:#cde3ff;
    text-decoration:underline;
  }
</style>

<div class="container" style="max-width:1100px;padding:16px 16px 60px;">

  <h4>Thanh to√°n</h4>

  <!-- b√°o l·ªói t·ª´ server (v√≠ d·ª• ch∆∞a ch·ªçn chi nh√°nh) -->
  <div th:if="${error != null}" class="error-box" th:text="${error}">
    C√≥ l·ªói.
  </div>

  <div class="row g-4">

    <!-- LEFT column -->
    <div class="col-lg-7">
      <div class="checkout-card">

        <!-- ‚úÖ route ƒë√∫ng v·ªõi controller: /user/checkout -->
        <form th:action="@{/checkout}" method="post" id="checkoutForm">
          <!-- CSRF -->
          <input type="hidden" th:if="${_csrf != null}"
                 th:name="${_csrf.parameterName}"
                 th:value="${_csrf.token}" />

          <!-- g·ª≠i id ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh -->
          <input type="hidden" name="addressId"
                 id="addressIdField"
                 th:value="${selectedAddressId != null ? selectedAddressId : ''}" />

          <!-- ===== ƒê·ªäA CH·ªà GIAO H√ÄNG ===== -->
          <div class="checkout-label"
               style="font-size:.8rem;text-transform:uppercase;letter-spacing:.03em;">
            ƒê·ªãa ch·ªâ giao h√†ng
          </div>
          <div style="color:#94a3b8;font-size:.8rem;font-weight:500;margin-bottom:1rem;">
            ƒêang d√πng ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh. Mu·ªën ƒë·ªïi ƒë·ªãa ch·ªâ giao kh√°c ‚Üí v√†o S·ªï ƒë·ªãa ch·ªâ ƒë·ªÉ ƒë·∫∑t l·∫°i m·∫∑c ƒë·ªãnh.
          </div>

          <!-- n·∫øu KH√îNG c√≥ ƒë·ªãa ch·ªâ n√†o -->
          <div th:if="${#lists.isEmpty(addresses)}"
               style="
                 background:rgba(239,68,68,.12);
                 border:1px solid rgba(239,68,68,.5);
                 color:#fecaca;
                 border-radius:12px;
                 font-size:.8rem;
                 font-weight:500;
                 line-height:1.4;
                 padding:.75rem 1rem;
                 margin-bottom:1rem;">
            B·∫°n ch∆∞a c√≥ ƒë·ªãa ch·ªâ giao h√†ng n√†o.
            Th√™m ƒë·ªãa ch·ªâ trong S·ªï ƒë·ªãa ch·ªâ tr∆∞·ªõc khi ƒë·∫∑t ƒë∆°n.
          </div>

          <!-- ch·ªâ render ƒë·ªãa ch·ªâ c√≥ default == true -->
          <div th:each="addr : ${addresses}"
               th:if="${addr.default}"
               class="addr-option addr-active"
               th:attr="data-id=${addr.id}">

            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
              <div style="flex-grow:1;margin-bottom:0;cursor:default;">
                <div style="font-weight:600;color:#fff;">
                  <span th:text="${addr.fullName}">Ng∆∞·ªùi nh·∫≠n</span>
                  <span style="color:#94a3b8;font-size:.8rem;font-weight:500;">
                    ‚Ä¢ <span th:text="${addr.phone}">0123xxxxxx</span>
                  </span>
                </div>

                <div style="font-size:.9rem;font-weight:500;line-height:1.4;margin-top:4px;">
                  <div th:text="${addr.line1}">123 L√™ L·ª£i</div>
                  <div th:text="${addr.ward}">Ph∆∞·ªùng 4</div>
                  <div>
                    <span th:text="${addr.district}">Qu·∫≠n 3</span>,
                    <span th:text="${addr.city}">TP.HCM</span>
                  </div>
                </div>
              </div>

              <div class="text-end" style="min-width:max-content;">
                <div class="addr-default-pill">
                  M·∫∂C ƒê·ªäNH
                </div>
              </div>
            </div>
          </div>

          <!-- ===== GHI CH√ö ===== -->
          <div class="mb-3 mt-4">
            <div class="checkout-label">Ghi ch√∫ cho c·ª≠a h√†ng</div>
            <textarea class="note-area"
                      rows="2"
                      name="note"
                      placeholder="V√≠ d·ª•: Giao tr∆∞·ªõc 17h, √≠t ng·ªçt, g√µ c·ª≠a nh·∫π th√¥i üòå"
                      style="resize:none;"></textarea>
          </div>

          <!-- ===== PH∆Ø∆†NG TH·ª®C THANH TO√ÅN ===== -->
          <div class="mb-3">
            <div class="checkout-label">Ph∆∞∆°ng th·ª©c thanh to√°n</div>
            <select class="form-control" name="paymentMethod">
              <option value="COD">Thanh to√°n khi nh·∫≠n h√†ng (COD)</option>
              <option value="VNPAY">VNPay</option>
            </select>
          </div>

          <!-- ===== CHI NH√ÅNH ===== -->
          <!-- ‚úÖ check theo model activeBranch do controller set -->
          <div class="branch-ok"
               th:if="${activeBranch != null}">
            Giao t·ª´ chi nh√°nh
            <b th:text="${activeBranch.name}"
               style="color:#fff;font-weight:600;">CakeStore CN</b>.
          </div>

          <!-- N·∫øu server ch∆∞a c√≥, ƒë·ªÉ JS check cookie BRANCH_ID -->
          <div class="branch-warning"
               th:if="${activeBranch == null}"
               id="branchWarnCheckout">
            ‚ö† Ch∆∞a ch·ªçn chi nh√°nh giao h√†ng.
            Ch·ªçn chi nh√°nh ·ªü header (g√≥c tr√™n) tr∆∞·ªõc khi ƒë·∫∑t h√†ng.
          </div>

          <!-- ===== SUBMIT ===== -->
          <div class="mt-4">
            <button class="btn-primary"
                    id="placeOrderBtn"
                    type="submit"
                    th:attr="disabled=${activeBranch == null or #lists.isEmpty(addresses)} ? 'disabled' : null">
              ƒê·∫∑t h√†ng
            </button>
          </div>

          <div class="text-end mt-3">
            <a th:href="@{/account/address}" class="link-manage-address">
              Qu·∫£n l√Ω s·ªï ƒë·ªãa ch·ªâ ‚Üí
            </a>
          </div>

        </form>

      </div>
    </div>

    <!-- RIGHT column: recap ƒë∆°n -->
    <div class="col-lg-5">
      <div class="summary-box">

        <h6 style="font-size:.9rem;font-weight:600;color:#94a3b8;margin-bottom:.75rem;">
          S·∫£n ph·∫©m
        </h6>

        <div th:each="l : ${cart.items()}" class="mini-item-row">
          <div class="name">
            <span th:text="${l.name}">B√°nh Kem D√¢u</span>
            <span class="qty">√ó <span th:text="${l.qty}">1</span></span>
          </div>
          <div class="text-end">
            <div th:text="${#numbers.formatDecimal(l.lineTotal(),0,'COMMA',0,'POINT')} + ' ƒë'">
              120,000 ƒë
            </div>
          </div>
        </div>

        <hr style="border-color:rgba(148,163,184,.25);margin:1rem 0;">

        <div class="line-item">
          <span>T·∫°m t√≠nh</span>
          <span th:text="${#numbers.formatDecimal(subtotal,0,'COMMA',0,'POINT')} + ' ƒë'">0 ƒë</span>
        </div>

        <div class="line-item">
          <span>Gi·∫£m gi√°</span>
          <span th:text="${#numbers.formatDecimal(discount,0,'COMMA',0,'POINT')} + ' ƒë'">0 ƒë</span>
        </div>

        <div class="line-item">
          <span>Ph√≠ giao</span>
          <span th:text="${#numbers.formatDecimal(shippingFee,0,'COMMA',0,'POINT')} + ' ƒë'">0 ƒë</span>
        </div>

        <div class="line-item total-line" style="margin-top:.75rem;">
          <span>T·ªïng thanh to√°n</span>
          <span th:text="${#numbers.formatDecimal(total,0,'COMMA',0,'POINT')} + ' ƒë'">0 ƒë</span>
        </div>

        <div class="mt-4 text-end">
          <a th:href="@{/cart}"
             style="font-size:.8rem;color:#93c5fd;text-decoration:none;font-weight:600;">
            ‚¨Ö Quay l·∫°i gi·ªè h√†ng
          </a>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
  // ƒë·ªçc cookie BRANCH_ID
  function getBranchCookie() {
    var found = document.cookie
      .split(';')
      .map(function (c){ return c.trim(); })
      .find(function (c){ return c.startsWith('BRANCH_ID='); });
    return found || null;
  }

  // N·∫øu server ch∆∞a c√≥ activeBranch (controller set null) th√¨ Thymeleaf s·∫Ω render branchWarnCheckout + disable n√∫t.
  // Check cookie: n·∫øu c√≥ BRANCH_ID th√¨ enable t·∫°m (session s·∫Ω sync ·ªü GET ti·∫øp theo).
  (function () {
    var warnEl = document.getElementById('branchWarnCheckout');
    var btnEl = document.getElementById('placeOrderBtn');

    if (!warnEl) {
      // server ƒë√£ c√≥ branch -> OK
      return;
    }

    var hasBranchCookie = !!getBranchCookie();
    if (hasBranchCookie) {
      warnEl.style.display = 'none';
      if (btnEl) btnEl.disabled = false;
    } else {
      if (btnEl) btnEl.disabled = true;
    }
  })();

  // ch·∫∑n submit n·∫øu v·∫´n ch∆∞a c√≥ branch (c·∫£ server l·∫´n cookie ƒë·ªÅu r·ªóng)
  document.getElementById('checkoutForm').addEventListener('submit', function(ev){
    var warnEl = document.getElementById('branchWarnCheckout');
    if (!warnEl) return; // server-side ƒë√£ c√≥ branch
    if (getBranchCookie()) return; // cookie c√≥ branch
    ev.preventDefault(); // block
  });
</script>

</body>
</html>
