<html xmlns:th="http://www.thymeleaf.org"
      th:replace="fragments/header :: layout(~{::body})">
<body style="background:#0b1220;color:#e5e7eb;font-family:'Inter',sans-serif;">

<style>
  :root{
    --bg:#0b1220;
    --card:#111827;
    --border:rgba(148,163,184,.25);
    --muted:#94a3b8;
    --text:#e5e7eb;
    --primary:#22c55e;
    --secondary:#60a5fa;
  }

  h4{
    font-weight:800;
    color:#d1fae5;
    margin:1rem 0;
    text-shadow:0 0 10px rgba(34,197,94,.15);
  }

  /* Filter bar */
  .filter-bar .form-control,
  .filter-bar .form-select{
    background:rgba(17,24,39,.6);
    border:1px solid var(--border);
    color:var(--text);
    border-radius:12px;
  }
  .filter-bar .form-control::placeholder{
    color:#9aa6b2
  }
  .filter-bar .form-control:focus,
  .filter-bar .form-select:focus{
    border-color:#60a5fa;
    box-shadow:0 0 0 6px rgba(96,165,250,.25);
    background:rgba(17,24,39,.85);
    color:#fff;
  }
  .btn-outline-primary{
    border-color:#60a5fa;
    color:#60a5fa;
    border-radius:12px;
    font-weight:600
  }
  .btn-outline-primary:hover{
    background:#60a5fa;
    color:#0b1220
  }

  /* Cards */
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:16px;
    overflow:hidden;
    transition:transform .2s, box-shadow .2s, border-color .2s;
  }
  .card:hover{
    transform:translateY(-3px);
    box-shadow:0 10px 24px rgba(34,197,94,.12), 0 0 0 1px rgba(96,165,250,.12);
    border-color:rgba(148,163,184,.35);
  }
  .card-img-top{
    height:180px;
    object-fit:cover;
    background:linear-gradient(135deg, rgba(96,165,250,.12), rgba(34,197,94,.12));
    border-bottom:1px solid var(--border);
  }
  .card-body{
    padding:14px 16px
  }
  .card-title{
    color:#e8eef6;
    margin-bottom:.35rem
  }
  .price{
    font-weight:800;
    color:#a5f3fc;
    font-size:1.05rem
  }

  /* Footer actions */
  .card-footer{
    background:rgba(17,24,39,.6);
    border-top:1px solid var(--border);
    padding:.75rem;
    display:flex;
    align-items:center;
    gap:.5rem;
    border-radius:0 0 16px 16px;
  }
  .card-footer form{
    margin:0;
    padding:0;
    display:flex;
    align-items:center;
  }

  /* HEART BUTTON (đồng bộ với các page khác) */
  .btn-like{
    border-radius:12px;
    width:40px;
    height:40px;
    padding:0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:600;
    font-size:1rem;
    line-height:1;
    transition:all .18s;
    box-shadow:0 10px 24px rgba(0,0,0,.6);
  }
  /* chưa yêu thích */
  .btn-like.off{
    border:2px solid rgba(239,68,68,.6);
    background:rgba(239,68,68,.06);
    color:#ff7777;
  }
  .btn-like.off:hover{
    background:rgba(239,68,68,.16);
    color:#fff;
    box-shadow:0 0 8px rgba(239,68,68,.6),0 20px 40px rgba(0,0,0,.8);
    transform:translateY(-1px);
  }
  /* đã yêu thích */
  .btn-like.on{
    border:2px solid rgba(239,68,68,1);
    background:radial-gradient(circle at 30% 30%, rgba(239,68,68,.9), rgba(139,0,0,.9) 70%);
    color:#fff;
    box-shadow:0 0 8px rgba(239,68,68,.8),0 24px 40px rgba(0,0,0,.9);
  }
  .btn-like.on:hover{
    filter:brightness(1.1);
    transform:translateY(-1px);
  }

  /* detail */
  .btn-outline-secondary{
    border:1px solid rgba(148,163,184,.35);
    color:#cbd5e1;
    background:rgba(30,41,59,.4);
    border-radius:12px;
    font-weight:600;
    transition:all .22s;
  }
  .btn-outline-secondary:hover{
    background:rgba(96,165,250,.16);
    border-color:rgba(148,163,184,.55);
    color:#fff;
    transform:translateY(-1px)
  }

  /* add to cart */
  .btn-primary{
    background:linear-gradient(135deg, var(--primary), var(--secondary));
    border:none;
    color:#07131f;
    border-radius:12px;
    font-weight:800;
    box-shadow:0 6px 18px rgba(34,197,94,.25);
    transition:transform .18s, filter .18s;
  }
  .btn-primary:hover{
    transform:translateY(-1px);
    filter:saturate(1.05)
  }
  .btn-primary:active{
    transform:scale(.97);
    box-shadow:inset 0 2px 8px rgba(0,0,0,.35)
  }

  /* Pagination */
  .pagination .page-link{
    background:rgba(17,24,39,.6);
    border:1px solid var(--border);
    color:#cbd5e1;
    border-radius:10px;
    margin:0 .15rem;
  }
  .pagination .page-link:hover{
    background:rgba(96,165,250,.16);
    color:#fff
  }
  .pagination .page-item.active .page-link{
    background:linear-gradient(135deg, var(--primary), var(--secondary));
    color:#07131f;
    border:none;
  }
  .pagination .page-item.disabled .page-link{
    opacity:.5;
    pointer-events:none
  }
</style>

<h4>Kết quả tìm kiếm</h4>

<form class="d-flex mb-3 filter-bar" method="get">
  <input class="form-control me-2" name="q" th:value="${q}" placeholder="Nhập từ khóa">
  <select class="form-select me-2" name="sort" th:value="${sort}">
    <option value="newest">Mới nhất</option>
    <option value="price_asc">Giá tăng</option>
    <option value="price_desc">Giá giảm</option>
    <option value="sold_desc">Bán chạy</option>
    <option value="rating_desc">Đánh giá cao</option>
  </select>
  <button class="btn btn-outline-primary">Lọc</button>
</form>

<div class="row row-cols-2 row-cols-md-4 g-3">
  <div class="col" th:each="p : ${data.content}">
    <div class="card h-100">

      <!-- Ảnh sản phẩm -->
      <img th:if="${p.thumbnailUrl != null}"
           th:src="${p.thumbnailUrl}"
           class="card-img-top"
           alt="">

      <img th:if="${p.thumbnailUrl == null}"
           th:src="@{/images/no-image.png}"
           class="card-img-top"
           alt="no image">

      <!-- Body -->
      <div class="card-body">
        <h6 class="card-title text-truncate" th:text="${p.name}">Tên</h6>
        <div class="price"
             th:text="${#numbers.formatDecimal(p.price,1,0)} + ' đ'">
          0
        </div>
      </div>

      <!-- Footer actions -->
      <div class="card-footer">

        <!-- Tim nếu ĐÃ đăng nhập -->
        <div th:if="${#authorization.expression('isAuthenticated()')}">
          <form th:action="@{/fav/toggle}" method="post" class="m-0 p-0">
            <input type="hidden" name="productId" th:value="${p.id}">
            <input type="hidden"
                   th:if="${_csrf!=null}"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}">
            <button type="submit"
                    class="btn-like"
                    th:classappend="${session.FAV_IDS != null and #lists.contains(session.FAV_IDS, p.id)} ? ' on' : ' off'"
                    onclick="this.disabled=true;this.form.submit();">
              ♥
            </button>
          </form>
        </div>

        <!-- Tim nếu CHƯA đăng nhập -->
        <div th:unless="${#authorization.expression('isAuthenticated()')}">
          <a href="/auth/login"
             class="btn-like off"
             title="Đăng nhập để yêu thích">♥</a>
        </div>

        <!-- Chi tiết -->
        <a th:href="@{'/product/' + ${p.id}}"
           class="btn btn-sm btn-outline-secondary flex-grow-1">
          Chi tiết
        </a>

        <!-- Thêm giỏ -->
        <form th:action="@{/cart/add}" method="post">
          <input type="hidden"
                 th:if="${_csrf != null}"
                 th:name="${_csrf.parameterName}"
                 th:value="${_csrf.token}" />
          <input type="hidden" name="productId" th:value="${p.id}">
          <button class="btn btn-sm btn-primary">Thêm giỏ</button>
        </form>

      </div>
    </div>
  </div>
</div>

<nav class="mt-3">
  <ul class="pagination">
    <li class="page-item"
        th:classappend="${data.first}? 'disabled'">
      <a class="page-link"
         th:href="@{|?q=${q}&sort=${sort}&page=${data.number-1}|}">«</a>
    </li>

    <li class="page-item"
        th:each="i : ${#numbers.sequence(0, data.totalPages-1)}"
        th:classappend="${i==data.number}? 'active'">
      <a class="page-link"
         th:text="${i+1}"
         th:href="@{|?q=${q}&sort=${sort}&page=${i}|}">1</a>
    </li>

    <li class="page-item"
        th:classappend="${data.last}? 'disabled'">
      <a class="page-link"
         th:href="@{|?q=${q}&sort=${sort}&page=${data.number+1}|}">»</a>
    </li>
  </ul>
</nav>

</body>
</html>
